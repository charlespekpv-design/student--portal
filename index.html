<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
        }

        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .session-timer {
            background: #f7fafc;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            color: #4a5568;
        }

        .session-timer.warning {
            background: #fed7d7;
            color: #742a2a;
            font-weight: bold;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            margin-bottom: 20px;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .course-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .course-item h3 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .course-info {
            color: #718096;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .course-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .tabs {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽ“ Student Portal</h1>
            <div class="user-info">
                <span id="sessionTimer" class="session-timer hidden"></span>
                <span id="userDisplay" class="hidden"></span>
                <button id="logoutBtn" class="btn btn-danger hidden">Logout</button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- Auth Section -->
        <div id="authSection">
            <div class="card">
                <h2>Login / Register</h2>
                <div class="tabs">
                    <button class="tab active" onclick="switchAuthTab('login')">Login</button>
                    <button class="tab" onclick="switchAuthTab('register')">Register</button>
                </div>

                <!-- Login Form -->
                <form id="loginForm">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="hidden">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Student ID</label>
                        <input type="text" id="registerStudentId" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Register</button>
                </form>
            </div>
        </div>

        <!-- Main Portal Section -->
        <div id="portalSection" class="hidden">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('courses')">All Courses</button>
                <button class="tab" onclick="switchTab('myCourses')">My Courses</button>
                <button class="tab" onclick="switchTab('manageCourses')">Manage Courses</button>
                <button class="tab" onclick="switchTab('profile')">Profile</button>
            </div>

            <!-- All Courses Tab -->
            <div id="coursesTab" class="card">
                <h2>Available Courses</h2>
                <div id="coursesList"></div>
            </div>

            <!-- My Courses Tab -->
            <div id="myCoursesTab" class="card hidden">
                <h2>My Enrolled Courses</h2>
                <div id="enrolledCoursesList"></div>
            </div>

            <!-- Manage Courses Tab -->
            <div id="manageCoursesTab" class="card hidden">
                <h2>Create New Course</h2>
                <form id="createCourseForm">
                    <div class="grid">
                        <div class="form-group">
                            <label>Course Code</label>
                            <input type="text" id="courseCode" required>
                        </div>
                        <div class="form-group">
                            <label>Course Name</label>
                            <input type="text" id="courseName" required>
                        </div>
                        <div class="form-group">
                            <label>Instructor</label>
                            <input type="text" id="courseInstructor" required>
                        </div>
                        <div class="form-group">
                            <label>Credits</label>
                            <input type="number" id="courseCredits" required>
                        </div>
                        <div class="form-group">
                            <label>Capacity</label>
                            <input type="number" id="courseCapacity" value="30" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="courseDescription"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">Create Course</button>
                </form>

                <h2 style="margin-top: 30px;">All Courses (Admin View)</h2>
                <div id="adminCoursesList"></div>
            </div>

            <!-- Profile Tab -->
            <div id="profileTab" class="card hidden">
                <h2>My Profile</h2>
                <div id="profileInfo"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let token = sessionStorage.getItem('token'); // Changed to sessionStorage
        let currentUser = null;
        
        // Session Management Variables
        const SESSION_TIMEOUT = 15 * 60 * 1000; // 15 minutes in milliseconds
        const INACTIVITY_TIMEOUT = 3 * 60 * 1000; // 3 minutes in milliseconds
        let sessionTimer = null;
        let inactivityTimer = null;
        let sessionStartTime = null;
        let displayTimer = null;

        // Check if user is logged in
        if (token) {
            const loginTime = sessionStorage.getItem('loginTime');
            const currentTime = new Date().getTime();
            
            // Check if session has expired
            if (loginTime && (currentTime - parseInt(loginTime)) > SESSION_TIMEOUT) {
                showAlert('Session expired. Please login again.', 'error');
                clearSession();
            } else {
                loadUserProfile();
            }
        }

        // Activity Detection - Reset inactivity timer on user interaction
        const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
        activityEvents.forEach(event => {
            document.addEventListener(event, resetInactivityTimer);
        });

        function startSessionTimers() {
            sessionStartTime = new Date().getTime();
            sessionStorage.setItem('loginTime', sessionStartTime.toString());
            
            // Clear any existing timers
            clearAllTimers();
            
            // Set session timeout (15 minutes)
            sessionTimer = setTimeout(() => {
                showAlert('Your session has expired. Please login again.', 'error');
                performLogout();
            }, SESSION_TIMEOUT);
            
            // Set initial inactivity timer (3 minutes)
            resetInactivityTimer();
            
            // Update display timer every second
            updateSessionDisplay();
            displayTimer = setInterval(updateSessionDisplay, 1000);
        }

        function resetInactivityTimer() {
            // Clear existing inactivity timer
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
            }
            
            // Only set new timer if user is logged in
            if (token && sessionStartTime) {
                inactivityTimer = setTimeout(() => {
                    showAlert('You have been logged out due to inactivity.', 'error');
                    performLogout();
                }, INACTIVITY_TIMEOUT);
            }
        }

        function updateSessionDisplay() {
            if (!sessionStartTime) return;
            
            const currentTime = new Date().getTime();
            const elapsedTime = currentTime - sessionStartTime;
            const remainingTime = SESSION_TIMEOUT - elapsedTime;
            
            if (remainingTime <= 0) {
                document.getElementById('sessionTimer').textContent = 'Session Expired';
                return;
            }
            
            const minutes = Math.floor(remainingTime / 60000);
            const seconds = Math.floor((remainingTime % 60000) / 1000);
            
            const timerElement = document.getElementById('sessionTimer');
            timerElement.textContent = `Session: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Warning when less than 2 minutes remaining
            if (remainingTime < 120000) {
                timerElement.classList.add('warning');
            } else {
                timerElement.classList.remove('warning');
            }
        }

        function clearAllTimers() {
            if (sessionTimer) clearTimeout(sessionTimer);
            if (inactivityTimer) clearTimeout(inactivityTimer);
            if (displayTimer) clearInterval(displayTimer);
        }

        function clearSession() {
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('loginTime');
            token = null;
            currentUser = null;
            sessionStartTime = null;
            clearAllTimers();
        }

        function performLogout() {
            clearSession();
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('portalSection').classList.add('hidden');
            document.getElementById('userDisplay').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('sessionTimer').classList.add('hidden');
        }

        // Auth Functions
        function switchAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const tabs = document.querySelectorAll('#authSection .tab');

            tabs.forEach(t => t.classList.remove('active'));

            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                tabs[0].classList.add('active');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                tabs[1].classList.add('active');
            }
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/students/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    sessionStorage.setItem('token', token); // Changed to sessionStorage
                    currentUser = data.student;
                    showAlert('Login successful!', 'success');
                    showPortal();
                    startSessionTimers(); // Start session timers
                } else {
                    showAlert(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showAlert('Error connecting to server', 'error');
            }
        });

        // Register
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const studentId = document.getElementById('registerStudentId').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${API_URL}/students/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, studentId, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    sessionStorage.setItem('token', token); // Changed to sessionStorage
                    currentUser = data.student;
                    showAlert('Registration successful!', 'success');
                    showPortal();
                    startSessionTimers(); // Start session timers
                } else {
                    showAlert(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                showAlert('Error connecting to server', 'error');
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            performLogout();
            showAlert('Logged out successfully', 'success');
        });

        // Load User Profile
        async function loadUserProfile() {
            try {
                const response = await fetch(`${API_URL}/students/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    showPortal();
                    startSessionTimers(); // Start session timers
                } else {
                    clearSession();
                    token = null;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        function showPortal() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('portalSection').classList.remove('hidden');
            document.getElementById('userDisplay').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            document.getElementById('sessionTimer').classList.remove('hidden');
            document.getElementById('userDisplay').textContent = `Welcome, ${currentUser.name}`;
            
            loadCourses();
            loadEnrolledCourses();
            displayProfile();
        }

        // Tab Switching
        function switchTab(tab) {
            const tabs = document.querySelectorAll('#portalSection > .tabs .tab');
            const sections = ['coursesTab', 'myCoursesTab', 'manageCoursesTab', 'profileTab'];
            
            tabs.forEach(t => t.classList.remove('active'));
            sections.forEach(s => document.getElementById(s).classList.add('hidden'));

            const tabMap = {
                'courses': { element: tabs[0], section: 'coursesTab', load: loadCourses },
                'myCourses': { element: tabs[1], section: 'myCoursesTab', load: loadEnrolledCourses },
                'manageCourses': { element: tabs[2], section: 'manageCoursesTab', load: loadAdminCourses },
                'profile': { element: tabs[3], section: 'profileTab', load: displayProfile }
            };

            if (tabMap[tab]) {
                tabMap[tab].element.classList.add('active');
                document.getElementById(tabMap[tab].section).classList.remove('hidden');
                tabMap[tab].load();
            }
        }

        // Load All Courses
        async function loadCourses() {
            try {
                const response = await fetch(`${API_URL}/courses`);
                const courses = await response.json();
                
                const container = document.getElementById('coursesList');
                container.innerHTML = courses.map(course => `
                    <div class="course-item">
                        <h3>${course.courseName} (${course.courseCode})</h3>
                        <div class="course-info">
                            <p><strong>Instructor:</strong> ${course.instructor}</p>
                            <p><strong>Credits:</strong> ${course.credits}</p>
                            <p><strong>Enrolled:</strong> ${course.enrolledStudents.length}/${course.capacity}</p>
                            <p>${course.description || 'No description available'}</p>
                        </div>
                        <div class="course-actions">
                            <button class="btn btn-primary" onclick="enrollCourse('${course._id}')">Enroll</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showAlert('Error loading courses', 'error');
            }
        }

        // Load Enrolled Courses
        async function loadEnrolledCourses() {
            try {
                const response = await fetch(`${API_URL}/students/courses/enrolled`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const courses = await response.json();
                
                const container = document.getElementById('enrolledCoursesList');
                if (courses.length === 0) {
                    container.innerHTML = '<p>You are not enrolled in any courses yet.</p>';
                } else {
                    container.innerHTML = courses.map(course => `
                        <div class="course-item">
                            <h3>${course.courseName} (${course.courseCode})</h3>
                            <div class="course-info">
                                <p><strong>Instructor:</strong> ${course.instructor}</p>
                                <p><strong>Credits:</strong> ${course.credits}</p>
                                <p>${course.description || 'No description available'}</p>
                            </div>
                            <div class="course-actions">
                                <button class="btn btn-danger" onclick="dropCourse('${course._id}')">Drop Course</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                showAlert('Error loading enrolled courses', 'error');
            }
        }

        // Enroll in Course
        async function enrollCourse(courseId) {
            try {
                const response = await fetch(`${API_URL}/courses/${courseId}/enroll`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Successfully enrolled in course!', 'success');
                    loadCourses();
                } else {
                    showAlert(data.error || 'Enrollment failed', 'error');
                }
            } catch (error) {
                showAlert('Error enrolling in course', 'error');
            }
        }

        // Drop Course
        async function dropCourse(courseId) {
            if (!confirm('Are you sure you want to drop this course?')) return;

            try {
                const response = await fetch(`${API_URL}/courses/${courseId}/drop`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Successfully dropped course', 'success');
                    loadEnrolledCourses();
                } else {
                    showAlert(data.error || 'Failed to drop course', 'error');
                }
            } catch (error) {
                showAlert('Error dropping course', 'error');
            }
        }

        // Create Course
        document.getElementById('createCourseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const courseData = {
                courseCode: document.getElementById('courseCode').value,
                courseName: document.getElementById('courseName').value,
                instructor: document.getElementById('courseInstructor').value,
                credits: parseInt(document.getElementById('courseCredits').value),
                capacity: parseInt(document.getElementById('courseCapacity').value),
                description: document.getElementById('courseDescription').value
            };

            try {
                const response = await fetch(`${API_URL}/courses`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(courseData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Course created successfully!', 'success');
                    e.target.reset();
                    loadAdminCourses();
                } else {
                    showAlert(data.error || 'Failed to create course', 'error');
                }
            } catch (error) {
                showAlert('Error creating course', 'error');
            }
        });

        // Load Admin Courses
        async function loadAdminCourses() {
            try {
                const response = await fetch(`${API_URL}/courses`);
                const courses = await response.json();
                
                const container = document.getElementById('adminCoursesList');
                container.innerHTML = courses.map(course => `
                    <div class="course-item">
                        <h3>${course.courseName} (${course.courseCode})</h3>
                        <div class="course-info">
                            <p><strong>Instructor:</strong> ${course.instructor}</p>
                            <p><strong>Credits:</strong> ${course.credits}</p>
                            <p><strong>Enrolled:</strong> ${course.enrolledStudents.length}/${course.capacity}</p>
                            <p>${course.description || 'No description available'}</p>
                        </div>
                        <div class="course-actions">
                            <button class="btn btn-danger" onclick="deleteCourse('${course._id}')">Delete Course</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showAlert('Error loading courses', 'error');
            }
        }

        // Delete Course
        async function deleteCourse(courseId) {
            if (!confirm('Are you sure you want to delete this course? This action cannot be undone.')) return;

            try {
                const response = await fetch(`${API_URL}/courses/${courseId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Course deleted successfully', 'success');
                    loadAdminCourses();
                } else {
                    showAlert(data.error || 'Failed to delete course', 'error');
                }
            } catch (error) {
                showAlert('Error deleting course', 'error');
            }
        }

        // Display Profile
        function displayProfile() {
            const container = document.getElementById('profileInfo');
            container.innerHTML = `
                <div class="course-item">
                    <h3>Student Information</h3>
                    <div class="course-info">
                        <p><strong>Name:</strong> ${currentUser.name}</p>
                        <p><strong>Email:</strong> ${currentUser.email}</p>
                        <p><strong>Student ID:</strong> ${currentUser.studentId}</p>
                        <p><strong>Enrolled Courses:</strong> ${currentUser.enrolledCourses ? currentUser.enrolledCourses.length : 0}</p>
                    </div>
                </div>
            `;
        }

        // Alert Function
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Handle page close/refresh - logout automatically
        window.addEventListener('beforeunload', () => {
            // Session will be cleared automatically because we use sessionStorage
            // which is automatically cleared when browser/tab is closed
        });
    </script>
</body>
</html>